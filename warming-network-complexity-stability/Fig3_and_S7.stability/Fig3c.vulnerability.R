# contributor: Linwei Wu

library(igraph)
source("/Users/maggieyuan/Documents/!annual_network/GitHub/Fig3_and_S7.stability/info.centrality.R")


setwd("/Users/maggieyuan/Documents/!annual_network/GitHub/Fig3_and_S7.stability/")

#### get graph ####
## you can 1) read in your own graph, 
## 2) construct a graph from OTU table, or 
## 3) read in the correlation matrix downloaded from MENAP to construct the graph.

## 2) construct a graph from OTU table
otutab<-read.table("input_file/OTUtable_AllOTUs_Y14_W.txt",header = T,row.names=1,sep="\t")
otutab[is.na(otutab)]<-0
##keep 12 otus
counts<-rowSums(otutab>0)
otutab<-otutab[counts>=12,]

comm<-t(otutab)

cormatrix=matrix(0,ncol(comm),ncol(comm))

for (i in 1:ncol(comm)){
  for (j in i:ncol(comm)){
    speciesi<-sapply(1:nrow(comm),function(k){
      ifelse(comm[k,i]>0,comm[k,i],ifelse(comm[k,j]>0,0.01,NA))
    })
    speciesj<-sapply(1:nrow(comm),function(k){
      ifelse(comm[k,j]>0,comm[k,j],ifelse(comm[k,i]>0,0.01,NA))
    })
    corij<-cor(log(speciesi)[!is.na(speciesi)],log(speciesj)[!is.na(speciesj)])
    
    cormatrix[i,j]<-cormatrix[j,i]<-corij
    
  }}

row.names(cormatrix)<-colnames(cormatrix)<-colnames(comm) # if processed using MENAP, OTU order should match in the original OTU table and the correlation matrix downloaded from MENAP.

cormatrix2<-cormatrix*(abs(cormatrix)>=0.80)  #only keep links above the cutoff point
cormatrix2[is.na(cormatrix2)]<-0
diag(cormatrix2)<-0    #no links for self-self   
cormatrix2[abs(cormatrix2)>0]<-1 # adjacency matrix
g = graph_from_adjacency_matrix(as.matrix(cormatrix2), mode="undirected", weighted = NULL, diag = FALSE, add.colnames = NULL) # note: this graph contains isolated nodes.
## End 2) construct a graph from OTU table

## 3) read in the correlation matrix downloaded from MENAP to construct the graph
cormatrix.input  <- matrix(0, 2567, 2567)
cormatrix.input[row(cormatrix.input) >= col(cormatrix.input)] <- scan("input_files/CorrelationMatrix_Y14_W.txt")
cormatrix <- t(cormatrix.input)
cormatrix[abs(cormatrix)<0.8]<-0
cormatrix[abs(cormatrix)>0]<-1 # adjacency matrix
g = graph_from_adjacency_matrix(as.matrix(cormatrix), mode="upper", weighted = NULL, diag = FALSE, add.colnames = NULL) # note: this graph contains isolated nodes.
## End 3) read in the correlation matrix downloaded from MENAP to construct the graph
### End get graph

# remove isolated nodes
iso_node_id = which(degree(g)==0)
g2 = delete.vertices(g, iso_node_id) # graph without isolated nodes

#check node number and links
length(V(g2));length(E(g2))   

# calculate vulnerability of each node
node.vul<-info.centrality.vertex(g2)
max(node.vul)


